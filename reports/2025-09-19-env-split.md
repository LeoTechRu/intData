# Разделение продуктивного и тестового контуров

## Контекст
- На локальных машинах и в CI тесты должны запускаться против PostgreSQL, совместимой по схеме с продуктивной базой.
- Пользователи жаловались, что прежние pytest-фикстуры создавали SQLite-движок и падали на типах `ARRAY`/`JSONB`.
- Новая политика требует выделить полноценный тестовый контур с отдельными доменами, ботами и веткой git.

## Требования к средам
- **Prod**: основная база данных `intdatadb`, домен `intdata.pro`, бот `@intDataBot`, git-ветка `main`.
- **Test/Staging**: база `intdatadb_test`, поддомены вида `test.intdata.pro`, бот `@intDataTestBot`, git-ветка `test`.
- CI должен деплоить ветку `test` в тестовый контур после успешного pr-мерджа, прогоняя pytest + фронтовые проверки.
- Продакшен принимает только fast-forward из `test` в `main` после ручной валидации.

## Git-процесс
1. Разработчики создают фиче-ветки от `test` (`feature/<epic>/<scope>-<agent>`).
2. PR в `test` обязательно содержит зелёные тесты и ссылку на эпик BACKLOG.
3. Ветку `test` запрещено удалять после merge (`github: allow merge, disable auto-delete`).
4. Раз в релизный цикл выполняется merge `test -> main` с повторным прогоном тестов и smoke в проде.

## Инфраструктурные шаги
- Настроить отдельный `.env.test`/секреты с `TEST_DB_*`, `TEST_PUBLIC_URL`, `TEST_BOT_TOKEN`.
- Создать отдельные процессы деплоя (например, AWS ECS/EKS, Docker Swarm или Heroku) с переменными `APP_MODE=test`.
- Подготовить Terraform/Ansible роли для создания S3 бакетов, очередей и ключей в двух контурах.
- Настроить мониторинг/алерты тестового контура с пониженными уровнями уведомлений.

## Следующие действия
1. Обновить AGENTS.md и Workflow, зафиксировав политику ветки `test` и запрет удаления.
2. В BACKLOG (E9) добавить задачи по автоматизации деплоя ветки `test` и управлению поддоменами/ботами.
3. В `reports/archive/tasklist.md` завести подзадачи для CI/CD и инфраструктуры.
4. Подготовить runbook по переходу релиза из `test` в `main`.
5. Автоматизировать злоупотребление sqlite-фабрик в pytest: миграция на Postgres фикстуры.

> Обновление 2025-09-20: автодеплой ветки `test` реализован в CI (`.github/workflows/deploy-test.yml`), секции README/AGENTS обновлены; добавлен runbook `reports/runbooks/test-to-main.md`, перечислены секреты `TEST_VPS_*`, `TEST_DB_*`, `TEST_BOT_*`.
