<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Время — LeonidPro</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <script type="module" src="/static/js/main.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    .timer-running { color: #059669; font-weight: 600; }
    .timer-stopped { color: #6b7280; }
  </style>
  </head>
<body>
  <header class="top-bar">
    <div class="top-left">
      <a class="brand" href="/"><span class="brand-type">LeonidPro</span></a>
      <nav class="main-nav" style="margin-left:12px; display:inline-flex; gap:10px;">
        <a href="/">Дашборд</a>
        <a href="/static/ui/tasks.html">Задачи</a>
        <a href="/static/ui/reminders.html">Напоминания</a>
        <a href="/static/ui/notes.html">Заметки</a>
        <a href="/static/ui/calendar.html">Календарь</a>
        <a href="/static/ui/time.html">Время</a>
      </nav>
    </div>
    <div class="top-center"><h2 class="page-title">Тайм‑трекер</h2></div>
    <div class="top-right"></div>
  </header>

  <div class="ui-layout">
    <div class="ui-notice">Запускайте таймеры, останавливайте и смотрите историю.</div>

    <section class="card" style="margin-bottom:1rem;">
      <div class="card-title">Новый таймер</div>
      <form id="time-start-form" class="ui-form">
        <label><div>Описание</div><input type="text" name="description" placeholder="Чем занимаетесь?"></label>
        <button class="button" type="submit">Запустить</button>
      </form>
      <div id="time-auth-hint" class="text-muted" style="display:none; padding:8px;">Требуется вход и связанный Telegram‑аккаунт</div>
    </section>

    <section class="card" style="margin-bottom:1rem;">
      <div class="card-title">Текущий таймер</div>
      <div id="running-empty" class="text-muted">Нет активного таймера</div>
      <div id="running-block" style="display:none;">
        <div id="running-line" class="timer-running" style="margin-bottom:8px;"></div>
        <button id="running-stop" class="button button-secondary" type="button">Остановить</button>
      </div>
    </section>

    <section class="card">
      <div class="card-title">История</div>
      <table class="ui-table">
        <thead><tr><th>ID</th><th>Начало</th><th>Конец</th><th>Длительность</th><th>Описание</th></tr></thead>
        <tbody id="time-list"></tbody>
      </table>
      <div id="time-empty" class="text-muted" style="display:none; padding:8px;">Записей пока нет</div>
    </section>
  </div>

  <script>
  const $ = (s) => document.querySelector(s);
  function fmt(dt){ try { return new Date(dt).toLocaleString(); } catch(e) { return dt || '—'; } }
  function minsBetween(a,b){ try { return Math.max(0, Math.floor((new Date(b)-new Date(a))/60000)); } catch(e){ return 0; } }

  async function fetchEntries(){
  const resp = await fetch('/api/v1/time', {credentials:'include'});
    if (!resp.ok){
      $('#time-auth-hint').style.display='block';
      return { entries: [] };
    }
    const data = await resp.json();
    return { entries: data };
  }

  function render(entries){
    const list = $('#time-list'); list.innerHTML = '';
    const running = entries.find(e=>!e.end_time);
    if (running){
      $('#running-empty').style.display='none';
      $('#running-block').style.display='block';
      $('#running-line').textContent = `#${running.id} — с ${fmt(running.start_time)} • ${running.description||'—'}`;
      $('#running-stop').dataset.entryId = String(running.id);
    } else {
      $('#running-empty').style.display='block';
      $('#running-block').style.display='none';
    }
    if (!entries.length){ $('#time-empty').style.display='block'; return; }
    $('#time-empty').style.display='none';
    for (const e of entries.sort((a,b)=>new Date(b.start_time)-new Date(a.start_time)).slice(0,20)){
      const tr = document.createElement('tr');
      const dur = e.end_time ? `${minsBetween(e.start_time, e.end_time)} мин` : 'идёт';
      tr.innerHTML = `<td>${e.id}</td><td>${fmt(e.start_time)}</td><td>${fmt(e.end_time)}</td><td>${dur}</td><td>${e.description||''}</td>`;
      list.appendChild(tr);
    }
  }

  async function reload(){
    const {entries} = await fetchEntries();
    render(entries);
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const form = $('#time-start-form');
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(form);
      const payload = { description: fd.get('description') || null };
    const resp = await fetch('/api/v1/time/start', {
        method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payload)
      });
      if (resp.ok){ form.reset(); reload(); }
    });
    $('#running-stop').addEventListener('click', async ()=>{
      const id = $('#running-stop').dataset.entryId;
      if (!id) return;
  const resp = await fetch(`/api/v1/time/${id}/stop`, { method:'POST', credentials:'include' });
      if (resp.ok){ reload(); }
    });
    reload();
  });
  </script>
  </body>
  </html>
