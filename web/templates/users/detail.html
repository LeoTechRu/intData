{% extends "base.html" %}
{% block title %}{{ profile.display_name }}{% endblock %}
{% block content %}
<div class="ui-layout">
  <header class="profile-hero">
    <div class="profile-hero__media">
      {% if profile.cover_url %}
        <div class="profile-hero__cover" style="background-image: linear-gradient(120deg, rgba(0,0,0,0.3), rgba(0,0,0,0.2)), url('{{ profile.cover_url }}');"></div>
      {% endif %}
      <div class="profile-hero__avatar">
        {% if profile.avatar_url %}
          <img src="{{ profile.avatar_url }}" alt="" />
        {% else %}
          <span aria-hidden="true">üë§</span>
        {% endif %}
      </div>
    </div>
    <div class="profile-hero__content">
      <h1 class="module-title">{{ profile.display_name }}</h1>
      {% if profile.headline %}
        <p class="module-subtitle">{{ profile.headline }}</p>
      {% endif %}
      {% if profile.summary %}
        <p class="profile-summary">{{ profile.summary }}</p>
      {% endif %}
      {% if profile.can_edit %}
        {% if editing %}
          <a class="button button--ghost" href="/users/{{ profile.slug }}">–û—Ç–º–µ–Ω–∞</a>
        {% else %}
          <a class="button" href="/users/{{ profile.slug }}?edit=true">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        {% endif %}
      {% endif %}
    </div>
  </header>

  {% if editing and profile.can_edit %}
    <section class="card">
      <div class="card-body">
        <form class="ui-form profile-edit-form" method="post" action="/users/{{ profile.slug }}" autocomplete="off">
          <div class="form-grid">
            <label>
              <span>–ü–æ–ª–Ω–æ–µ –∏–º—è</span>
              <input type="text" name="full_name" value="{{ profile_user.full_name or '' }}">
            </label>
            <label>
              <span>Username</span>
              <input type="text" name="username" value="{{ profile_user.username }}" disabled>
            </label>
            <label>
              <span>Email</span>
              <input type="email" name="email" value="{{ profile_user.email or '' }}">
            </label>
            <label>
              <span>–¢–µ–ª–µ—Ñ–æ–Ω</span>
              <input type="text" name="phone" value="{{ profile_user.phone or '' }}">
            </label>
            <label>
              <span>–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</span>
              <input type="date" name="birthday" value="{{ profile_user.birthday.strftime('%Y-%m-%d') if profile_user.birthday else '' }}">
            </label>
            <label>
              <span>–Ø–∑—ã–∫</span>
              <input type="text" name="language" value="{{ profile_user.language or '' }}">
            </label>
            <label>
              <span>–ó–∞–≥–æ–ª–æ–≤–æ–∫</span>
              <input type="text" name="headline" value="{{ profile.headline or '' }}">
            </label>
            <label class="full">
              <span>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</span>
              <textarea name="summary" rows="3">{{ profile.summary or '' }}</textarea>
            </label>
            <label>
              <span>Avatar URL</span>
              <input type="url" name="avatar_url" value="{{ profile.avatar_url or '' }}" placeholder="https://...">
            </label>
            <label>
              <span>Cover URL</span>
              <input type="url" name="cover_url" value="{{ profile.meta.cover or profile.cover_url or '' }}" placeholder="https://...">
            </label>
            <label class="full">
              <span>–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</span>
              <input type="text" name="tags" value="{{ ', '.join(profile.tags) }}">
            </label>
            <label>
              <span>–í–∏–¥–∏–º–æ—Å—Ç—å –≤ –∫–∞—Ç–∞–ª–æ–≥–µ</span>
              <select name="directory_visibility">
                <option value="private" {% if profile.visibility == 'private' %}selected{% endif %}>–°–∫—Ä—ã—Ç (—Ç–æ–ª—å–∫–æ –≤—ã)</option>
                <option value="authenticated" {% if profile.visibility == 'authenticated' %}selected{% endif %}>–¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                <option value="public" {% if profile.visibility == 'public' %}selected{% endif %}>–ü—É–±–ª–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</option>
              </select>
            </label>
          </div>
          <div class="form-actions">
            <button type="submit" class="button button--primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <a class="button button--ghost" href="/users/{{ profile.slug }}">–û—Ç–º–µ–Ω–∞</a>
          </div>
        </form>
      </div>
    </section>
  {% else %}
    <section class="cards-grid" style="--cards-grid-min: 320px;">
      <section class="card" data-widget="profile-contact">
        <div class="card-body">
          <h2 class="card-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
          <dl class="profile-details">
            <div><dt>Email</dt><dd>{{ profile_user.email or '‚Äî' }}</dd></div>
            <div><dt>–¢–µ–ª–µ—Ñ–æ–Ω</dt><dd>{{ profile_user.phone or '‚Äî' }}</dd></div>
            <div><dt>–Ø–∑—ã–∫</dt><dd>{{ profile_user.language or '‚Äî' }}</dd></div>
            <div><dt>Telegram</dt><dd>{% if profile_user.telegram_accounts %}{% for acc in profile_user.telegram_accounts %}@{{ acc.username }}{% if not loop.last %}, {% endif %}{% endfor %}{% else %}‚Äî{% endif %}</dd></div>
          </dl>
        </div>
      </section>
      <section class="card" data-widget="profile-links">
        <div class="card-body">
          <h2 class="card-title">–°—Å—ã–ª–∫–∏</h2>
          {% set links = profile.meta.links or [] %}
          {% if links %}
            <ul class="profile-links">
              {% for link in links %}
                <li><a href="{{ link.url }}" target="_blank" rel="noopener">{{ link.label or link.url }}</a></li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">–ù–µ—Ç —Å—Å—ã–ª–æ–∫</p>
          {% endif %}
        </div>
      </section>
      <section class="card" data-widget="profile-tags">
        <div class="card-body">
          <h2 class="card-title">–ù–∞–≤—ã–∫–∏ –∏ —Ñ–æ–∫—É—Å—ã</h2>
          {% if profile.tags %}
            <ul class="profile-tags">
              {% for tag in profile.tags %}
                <li>{{ tag }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted">–¢–µ–≥–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã</p>
          {% endif %}
        </div>
      </section>
      <section class="card" data-widget="profile-sections" style="grid-column:1/-1;">
        <div class="card-body">
          <h2 class="card-title">–°–µ–∫—Ü–∏–∏</h2>
          {% if profile.sections %}
            <div class="profile-sections">
              {% for section in profile.sections %}
                <article class="profile-section">
                  <h3>{{ section.title or section.id }}</h3>
                  <p class="text-muted">–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è, –∫–æ–≥–¥–∞ —ç—Ç–∞ —Å–µ–∫—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞.</p>
                </article>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted">–î–ª—è –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ–∫—Ü–∏–π.</p>
          {% endif %}
        </div>
      </section>
    </section>
  {% endif %}

  {% if profile.can_edit %}
    <section class="card" data-widget="profile-access" data-profile-slug="{{ profile.slug }}" data-profile-entity="users" data-profile-grants='{{ profile.grants | tojson | safe }}'>
      <div class="card-body">
        <h2 class="card-title">–î–æ—Å—Ç—É–ø –∫ –ø—Ä–æ—Ñ–∏–ª—é</h2>
        <p class="text-muted">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ, –∫—Ç–æ –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å: –æ—Ç–º–µ—Ç—å—Ç–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≥—Ä—É–ø–ø—É –∏–ª–∏ –ø—Ä–æ–µ–∫—Ç.</p>
        <form class="profile-grants-form">
          <fieldset class="profile-grants-toggles">
            <label><input type="checkbox" name="grant_public"> –û—Ç–∫—Ä—ã—Ç—å –¥–ª—è –≤—Å–µ—Ö</label>
            <label><input type="checkbox" name="grant_authenticated"> –î–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º</label>
          </fieldset>
          <div class="profile-grants-list">
            <table>
              <thead>
                <tr><th>–ê—É–¥–∏—Ç–æ—Ä–∏—è</th><th>ID</th><th>–°–µ–∫—Ü–∏–∏</th><th></th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="profile-grants-add">
            <label>
              <span>–¢–∏–ø</span>
              <select name="audience_type">
                <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                <option value="group">–ì—Ä—É–ø–ø–∞ (Telegram ID)</option>
                <option value="project">–ü—Ä–æ–µ–∫—Ç</option>
                <option value="area">Area</option>
              </select>
            </label>
            <label>
              <span>ID</span>
              <input type="text" name="subject_id" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 42">
            </label>
            <label>
              <span>–°–µ–∫—Ü–∏–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –ø—É—Å—Ç–æ = –≤—Å–µ)</span>
              <input type="text" name="sections" placeholder="overview,activity">
            </label>
            <button type="button" class="button button--ghost" data-action="grant-add">–î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
          <footer class="form-actions">
            <span class="text-muted" data-state="grants-status"></span>
          </footer>
        </form>
      </div>
    </section>
  {% endif %}
</div>
{% endblock %}
