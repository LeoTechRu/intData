{% extends "base.html" %}
{% block content %}
<section class="page" aria-labelledby="h-habits">
  <h1 id="h-habits">Привычки</h1>
  {% if show_tg_cta %}
  <div class="c-card c-card--warning" id="tg-link-banner">
    Свяжите Telegram для наград —
    <a href="/settings#telegram-linking">Настройки</a>
  </div>
  {% endif %}

  <form id="habit-form" class="c-card" style="margin-block:12px">
    <input name="name" type="text" placeholder="Новая привычка" required>
    <div class="c-card__bottom">
      <select name="frequency" aria-label="Частота">
        <option value="daily">Ежедневно</option>
        <option value="weekly">Еженедельно</option>
        <option value="monthly">Ежемесячно</option>
      </select>
      <button class="ui-iconbtn" type="submit" data-tooltip="Сохранить" aria-label="Сохранить">
        <svg><use href="#i-check"/></svg>
      </button>
    </div>
  </form>

  <div id="habitGrid" class="cards-grid" aria-live="polite"></div>
</section>
{% endblock %}
{% block scripts %}
<script type="module">
import {confirmDialog} from '/static/js/ui/confirm.js';
import {handleHabitApiResponse} from '/static/js/habits_v1.js';
const B = window.API_BASE;

function percent(progress){
  if(!progress) return 0;
  const set = new Set(progress);
  const today = new Date();
  let done = 0;
  for(let i=0;i<30;i++){
    const d = new Date(today);
    d.setDate(d.getDate()-i);
    const k = d.toISOString().slice(0,10);
    if(set.has(k)) done++;
  }
  return Math.round(done/30*100);
}

function cardTemplate(h){
  const pct = percent(h.progress);
  const today = new Date().toISOString().slice(0,10);
  const done = h.progress && h.progress.includes(today);
  return `<article class="c-card" data-id="${h.id}">
    <div class="c-card__top">
      <button class="ui-iconbtn ui-iconbtn--danger js-del" aria-label="Удалить" data-tooltip="Удалить">
        <svg><use href="#i-trash"/></svg>
      </button>
    </div>
    <div class="c-card__content">
      <div class="title">${h.name}</div>
      <div class="habit-progress"><div style="width:${pct}%"></div></div>
      <div class="muted" style="font-size:12px;">${pct}%</div>
    </div>
    <div class="c-card__bottom">
      <button class="ui-iconbtn js-toggle" aria-label="${done?'Сбросить':'Отметить'}" data-tooltip="${done?'Сбросить':'Отметить'}">
        <svg><use href="#i-check"/></svg>
      </button>
    </div>
  </article>`;
}

async function load(){
  const r = await fetch(`${B}/habits`, {credentials:'include'});
  const grid = document.getElementById('habitGrid');
  grid.innerHTML='';
  if(!r.ok){
    grid.innerHTML = '<p class="text-muted">Требуется вход</p>';
    return;
  }
  const data = await r.json();
  if(!data.length){
    grid.innerHTML = '<p class="text-muted">Нет данных</p>';
    return;
  }
  for(const h of data){
    grid.insertAdjacentHTML('beforeend', cardTemplate(h));
  }
}

document.getElementById('habit-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = {name: fd.get('name'), frequency: fd.get('frequency')};
  const r = await fetch(`${B}/habits`, {
    method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payload)
  });
  if(r.ok){ e.target.reset(); load(); }
});

document.getElementById('habitGrid').addEventListener('click', async (e)=>{
  const card = e.target.closest('.c-card');
  if(!card) return;
  const id = card.dataset.id;
  if(e.target.closest('.js-toggle')){
    const today = new Date().toISOString().slice(0,10);
    const resp = await fetch(`${B}/habits/${id}/toggle`, {
      method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({date: today})
    });
    if (handleHabitApiResponse(resp, e.target.closest('button'))) return;
    load();
  } else if(e.target.closest('.js-del')){
    const ok = await confirmDialog({message:'Удалить привычку?'});
    if(!ok) return;
    await fetch(`${B}/habits/${id}`, {method:'DELETE', credentials:'include'});
    load();
  }
});

load();
</script>
{% endblock %}
