{% set admin_anchor_id = admin_anchor_id if admin_anchor_id is defined and admin_anchor_id else 'cup-admin-tools' %}
{% set admin_heading_tag = admin_heading_tag if admin_heading_tag is defined and admin_heading_tag else 'h2' %}
{% set admin_heading_description = admin_heading_description if admin_heading_description is defined and admin_heading_description else 'Инструменты только для администраторов платформы.' %}
<section id="{{ admin_anchor_id }}" class="cup-admin">
  <header class="cup-admin__header">
    <{{ admin_heading_tag }} class="cup-admin__title">Админский сектор</{{ admin_heading_tag }}>
    <p class="cup-admin__description">{{ admin_heading_description }}</p>
  </header>
  <div class="cup-admin__grid">
    <section id="admin-users-web" class="card cup-admin__card">
      <div class="card-title">Web-пользователи</div>
      {% if admin_users_web %}
      <div class="cup-admin__table-wrap">
        <table class="ui-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>username</th>
              <th>Telegram-аккаунты</th>
              <th>Роль</th>
            </tr>
          </thead>
          <tbody>
          {% for user in admin_users_web %}
            <tr>
              <td>{{ user.id }}</td>
              <td>{{ user.username }}</td>
              <td>
                {% for tg in user.telegram_accounts %}
                  {{ tg.username or tg.telegram_id }}
                  <button class="unlink-btn" data-web="{{ user.id }}" data-tg="{{ tg.id }}" aria-label="Отвязать Telegram">×</button><br/>
                {% endfor %}
                <select id="link-select-{{ user.id }}">
                  <option value="">—</option>
                  {% for tg in admin_users_tg %}
                    <option value="{{ tg.id }}">{{ tg.username or tg.telegram_id }}</option>
                  {% endfor %}
                </select>
                <button class="link-btn" data-web="{{ user.id }}">Связать</button>
              </td>
              <td>
                <select class="web-role" data-user-id="{{ user.id }}">
                  {% for r in admin_roles %}
                    <option value="{{ r }}" {% if user.role == r %}selected{% endif %}>{{ r }}</option>
                  {% endfor %}
                </select>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">нет пользователей</p>
      {% endif %}
    </section>

    <section id="admin-users-tg" class="card cup-admin__card">
      <div class="card-title">Telegram-пользователи</div>
      {% if admin_users_tg %}
      <div class="cup-admin__table-wrap">
        <table class="ui-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>username</th>
              <th>Имя</th>
              <th>Фамилия</th>
              <th>Роль</th>
            </tr>
          </thead>
          <tbody>
          {% for user in admin_users_tg %}
            <tr>
              <td>{{ user.telegram_id }}</td>
              <td>{{ user.username or '' }}</td>
              <td>{{ user.first_name }}</td>
              <td>{{ user.last_name or '' }}</td>
              <td>
                <select class="tg-role" data-tg-id="{{ user.telegram_id }}">
                  {% for r in admin_roles %}
                    <option value="{{ r }}" {% if user.role == r %}selected{% endif %}>{{ r }}</option>
                  {% endfor %}
                </select>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">нет пользователей</p>
      {% endif %}
    </section>

    <section id="admin-groups" class="card cup-admin__card">
      <div class="card-title">Группы Telegram</div>
      {% if admin_groups %}
      <ul class="cup-admin__groups">
        {% for item in admin_groups %}
        <li>
          <div class="cup-admin__group-title">{{ item.group.title }} <span class="text-muted">({{ item.group.participants_count }} участников)</span></div>
          {% if item.members %}
          <ul>
            {% for member in item.members %}
            <li>{{ member.first_name }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-muted">нет групп</p>
      {% endif %}
    </section>

    <section id="admin-group-moderation" class="card cup-admin__card">
      <div class="card-title">Модерация групп</div>
      {% if admin_group_moderation %}
      <div class="cup-admin__table-wrap">
        <table class="ui-table">
          <thead>
            <tr>
              <th>Группа</th>
              <th>Активные</th>
              <th>Тихие</th>
              <th>Без оплаты</th>
              <th>Последняя активность</th>
            </tr>
          </thead>
          <tbody>
            {% for item in admin_group_moderation %}
            <tr>
              <td>{{ item.group.title }}</td>
              <td>{{ item.active }}/{{ item.members }}</td>
              <td>{{ item.quiet }}</td>
              <td>{{ item.unpaid }}</td>
              <td>
                {% if item.last_activity %}
                  {{ item.last_activity.strftime('%d.%m %H:%M') }}
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">Нет данных о модерации.</p>
      {% endif %}
      <footer class="cup-admin__footer">
        <a href="/groups" class="link-muted">Открыть CRM по группам</a>
      </footer>
    </section>

    <section id="admin-settings" class="card cup-admin__card">
      <div class="card-title">Настройки приложения</div>
      <div class="grid grid-2">
        <form id="adm-branding" class="ui-form">
          <label>Имя бренда<input class="control" type="text" name="BRAND_NAME" value="{{ BRAND_NAME }}"></label>
          <label>Публичный URL<input class="control" type="url" name="PUBLIC_URL" value="{{ PUBLIC_URL }}"></label>
          <label>URL бота<input class="control" type="url" name="BOT_LANDING_URL" value="{{ BOT_LANDING_URL }}"></label>
          <button class="button" type="submit">Сохранить</button>
        </form>

        <form id="adm-telegram" class="ui-form">
          <label><input type="checkbox" name="TG_LOGIN_ENABLED" {% if TG_LOGIN_ENABLED %}checked{% endif %}> Включить Telegram Login</label>
          <label>Имя бота (без @)<input class="control" type="text" name="TG_BOT_USERNAME" value="{{ TG_TG_BOT_USERNAME or '' }}"></label>
          <label>Новый токен бота<input class="control" type="password" name="TG_BOT_TOKEN" placeholder="Задать новый токен"></label>
          <div class="grid" style="grid-template-columns: 1fr 1fr; gap:8px;">
            <button class="button" type="submit">Сохранить</button>
            <div style="display:flex; gap:8px; justify-content:flex-end;">
              <button class="button" type="button" id="btn-restart-web">Рестарт веба</button>
              <button class="button" type="button" id="btn-restart-bot">Рестарт бота</button>
            </div>
          </div>
        </form>
      </div>
      <div id="adm-msg" class="muted" style="margin-top:8px;"></div>
    </section>
  </div>
</section>
<script>
const B = window.API_BASE;
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.tg-role').forEach(sel => {
    sel.addEventListener('change', async e => {
      const id = e.target.dataset.tgId;
      const role = e.target.value;
      await fetch(`${B}/admin/role/${id}?role=${role}`, {method: 'POST'});
      location.reload();
    });
  });
  document.querySelectorAll('.web-role').forEach(sel => {
    sel.addEventListener('change', async e => {
      const id = e.target.dataset.userId;
      const role = e.target.value;
      await fetch(`${B}/admin/web/role/${id}?role=${role}`, {method: 'POST'});
      location.reload();
    });
  });
  document.querySelectorAll('.unlink-btn').forEach(btn => {
    btn.addEventListener('click', async e => {
      const webId = e.target.dataset.web;
      const tgId = e.target.dataset.tg;
      await fetch(`${B}/admin/web/unlink?web_user_id=${webId}&tg_user_id=${tgId}`, {method: 'POST'});
      location.reload();
    });
  });
  document.querySelectorAll('.link-btn').forEach(btn => {
    btn.addEventListener('click', async e => {
      const webId = e.target.dataset.web;
      const select = document.getElementById(`link-select-${webId}`);
      const tgId = select.value;
      if (!tgId) return;
      await fetch(`${B}/admin/web/link?web_user_id=${webId}&tg_user_id=${tgId}`, {method: 'POST'});
      location.reload();
    });
  });
});

async function patch(url, data){
  const r = await fetch(url, {method:'PATCH', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(data)});
  return r.ok;
}
document.getElementById('adm-branding')?.addEventListener('submit', async (e)=>{
  e.preventDefault(); const fd = new FormData(e.currentTarget);
  const ok = await patch(`${B}/admin/settings/branding`, {
    BRAND_NAME: fd.get('BRAND_NAME'), PUBLIC_URL: fd.get('PUBLIC_URL'), BOT_LANDING_URL: fd.get('BOT_LANDING_URL')
  });
  document.getElementById('adm-msg').textContent = ok ? 'Сохранено' : 'Ошибка сохранения';
  if (ok) location.reload();
});
document.getElementById('adm-telegram')?.addEventListener('submit', async (e)=>{
  e.preventDefault(); const fd = new FormData(e.currentTarget);
  const ok = await patch(`${B}/admin/settings/telegram`, {
    TG_LOGIN_ENABLED: !!fd.get('TG_LOGIN_ENABLED'), TG_BOT_USERNAME: (fd.get('TG_BOT_USERNAME')||'').toString().trim()||null, TG_BOT_TOKEN: (fd.get('TG_BOT_TOKEN')||'').toString().trim()||null
  });
  document.getElementById('adm-msg').textContent = ok ? 'Сохранено' : 'Ошибка сохранения';
});
async function restart(target){
  const r = await fetch(`${B}/admin/restart?target=`+encodeURIComponent(target), {method:'POST', credentials:'include'});
  const j = await r.json().catch(()=>({}));
  document.getElementById('adm-msg').textContent = j.ok ? `Рестарт ${target} выполнен` : `Ошибка рестарта ${target}: ${j.error||j.stderr||j.code}`;
}
document.getElementById('btn-restart-web')?.addEventListener('click', ()=> restart('web'));
document.getElementById('btn-restart-bot')?.addEventListener('click', ()=> restart('bot'));
</script>
