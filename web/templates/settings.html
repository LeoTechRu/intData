{% extends "base.html" %}
{% block title %}Настройки{% endblock %}
{% block content %}
<div class="settings-page" data-settings-root data-is-admin="{{ 'true' if is_admin else 'false' }}">
  <main id="main-content" tabindex="-1">
    <section class="settings-section">
      <header class="settings-section__header">
        <h1 class="settings-section__title">Персонализация</h1>
        <p class="settings-section__subtitle">Настройте рабочий стол и меню под свои сценарии — изменения сохраняются в вашем профиле.</p>
      </header>
      <div class="settings-grid">
        <section class="settings-card" aria-labelledby="dashboard-settings-title">
          <div class="settings-card__header">
            <h2 id="dashboard-settings-title">Виджеты дашборда</h2>
            <p>Управляйте набором и порядком карточек на странице «Обзор». Скрытые виджеты всегда можно вернуть.</p>
          </div>
          <form id="dashboard-settings-form" class="settings-form stack gap-3" data-feedback>
            {% for w in dashboard_widgets %}
            <label class="settings-checkbox">
              <input type="checkbox" name="{{ w.key }}" checked>
              <span>{{ w.label }}</span>
            </label>
            {% endfor %}
            <div class="settings-actions">
              <button class="button" type="submit">Сохранить</button>
              <button class="button button--ghost" type="button" data-dashboard-reset>Сбросить</button>
            </div>
          </form>
        </section>

        <section class="settings-card" aria-labelledby="favorites-settings-title">
          <div class="settings-card__header">
            <h2 id="favorites-settings-title">Избранное меню</h2>
            <p>Отметьте разделы для быстрого доступа из меню профиля. Порядок сохраняется автоматически.</p>
          </div>
          <form id="favorites-settings-form" class="settings-form stack gap-3" data-feedback>
            {% for p in favorite_pages %}
            <label class="settings-checkbox">
              <input type="checkbox" name="{{ p.path }}" data-label="{{ p.label }}">
              <span>{{ p.label }}</span>
            </label>
            {% endfor %}
            <div class="settings-actions">
              <button class="button" type="submit">Сохранить</button>
              <button class="button button--ghost" type="button" data-favorites-reset>Сбросить</button>
            </div>
          </form>
        </section>
      </div>
    </section>

    <section class="settings-section" id="areas">
      <header class="settings-section__header">
        <h2 class="settings-section__title">Области жизни (PARA)</h2>
        <p class="settings-section__subtitle">Области задают глобальную структуру: проекты, задачи и ресурсы наследуют выбранную область автоматически. Управляйте деревом будто это ваша карта приоритетов.</p>
      </header>
      <section class="settings-card settings-card--wide areas-settings" aria-labelledby="areas-settings-title" data-areas-root>
        <div class="settings-card__header">
          <h3 id="areas-settings-title">Структура иерархии</h3>
          <p>Создавайте новые области, группируйте их вложенно и держите систему PARA в актуальном состоянии. Изменения применяются мгновенно во всех модулях.</p>
        </div>
        <div class="areas-layout" data-areas-pane>
          <div class="areas-layout__column areas-layout__column--tree">
            <form class="areas-create" data-areas-create data-feedback>
              <div class="areas-create__group">
                <label class="areas-field">
                  <span class="areas-field__label">Название области</span>
                  <input class="areas-field__control" type="text" name="name" placeholder="Напр.: Здоровье" autocomplete="off" required>
                </label>
              </div>
              <div class="areas-create__inline">
                <label class="areas-field">
                  <span class="areas-field__label">Цвет</span>
                  <input class="areas-field__control areas-field__control--color" type="color" name="color" value="#F1F5F9" aria-label="Цвет области">
                </label>
                <label class="areas-field areas-field--grow">
                  <span class="areas-field__label">Разместить внутри</span>
                  <select class="areas-field__control" name="parent_id" data-areas-parent>
                    <option value="">Верхний уровень</option>
                  </select>
                </label>
              </div>
              <div class="settings-actions">
                <button class="button" type="submit">Создать область</button>
                <button class="button button--ghost" type="reset">Сбросить</button>
              </div>
            </form>
            <div class="areas-tree-wrapper" data-areas-scroll>
              <div class="areas-skeleton" data-areas-skeleton>
                <div></div>
                <div></div>
                <div></div>
              </div>
              <ul class="areas-tree" data-areas-tree role="tree" aria-describedby="areas-tree-hint" tabindex="0"></ul>
              <p class="areas-empty" data-areas-empty hidden>Пока нет ни одной области. Создайте первую, чтобы подключить проекты и задачи.</p>
              <p class="areas-status" data-areas-status></p>
              <p id="areas-tree-hint" class="areas-hint">Используйте клавиши стрелок и Enter, чтобы выбрать область, либо мышь/тач. Выбранная область появится справа.</p>
            </div>
          </div>
          <div class="areas-layout__column areas-layout__column--detail">
            <div class="areas-detail" data-areas-detail data-state="empty">
              <div class="areas-detail__empty" data-areas-detail-empty>
                <h4>Выберите область</h4>
                <p>Нажмите на область слева, чтобы настроить её имя и расположение. Мы также покажем полный путь в дереве для контекста.</p>
              </div>
              <div class="areas-detail__panel" data-areas-detail-panel hidden>
                <header class="areas-detail__header">
                  <h4 data-areas-detail-name></h4>
                  <span class="areas-detail__badge" data-areas-detail-path></span>
                </header>
                <form class="areas-detail__form settings-form" data-areas-detail-form data-feedback>
                  <label class="areas-field">
                    <span class="areas-field__label">Переименовать</span>
                    <input class="areas-field__control" type="text" name="name" autocomplete="off" required>
                  </label>
                  <label class="areas-field">
                    <span class="areas-field__label">Переместить в</span>
                    <select class="areas-field__control" name="parent_id" data-areas-detail-parent>
                      <option value="">Верхний уровень</option>
                    </select>
                  </label>
                  <div class="settings-actions">
                    <button class="button" type="submit">Сохранить изменения</button>
                    <button class="button button--ghost" type="button" data-areas-detail-cancel>Отменить</button>
                  </div>
                </form>
                <footer class="areas-detail__footer">
                  <p class="areas-detail__meta" data-areas-detail-meta></p>
                  <p class="areas-detail__help">Напоминание: у каждой сущности должна быть область. Изменения здесь моментально обновят фильтры в задачах, календаре и привычках.</p>
                </footer>
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <section class="settings-section">
      <header class="settings-section__header">
        <h2 class="settings-section__title">Тема интерфейса</h2>
        <p class="settings-section__subtitle">Создайте свой пресет: выберите цвет, режим и градиент. Мы автоматически подберём контраст для читабельности.</p>
      </header>
      <section class="settings-card settings-card--wide" aria-labelledby="user-theme-title">
        <div class="settings-card__header">
          <h3 id="user-theme-title">Личный пресет</h3>
          <p>Работает только для вашего аккаунта. Можно быстро сменить оформление или вернуться к корпоративным настройкам.</p>
        </div>
        <form id="user-theme-form" class="theme-form" data-theme-layer="user" data-feedback>
          <div class="theme-preview" data-theme-preview>
            <div class="theme-preview__gradient" data-theme-gradient></div>
            <div class="theme-preview__content">
              <span class="theme-preview__badge">Предпросмотр</span>
              <h4 class="theme-preview__title">Ваш дашборд</h4>
              <p class="theme-preview__text">Градиент и цвета обновляются по мере выбора. Сохраняйте, когда готовы.</p>
            </div>
          </div>
          <div class="theme-form__grid">
            <label class="theme-form__field">
              <span class="theme-form__label">Режим</span>
              <select name="mode" data-theme-field>
                <option value="system">Авто (по системе)</option>
                <option value="light">Светлая</option>
                <option value="dark">Тёмная</option>
              </select>
            </label>
            <label class="theme-form__field">
              <span class="theme-form__label">Основной цвет</span>
              <div class="theme-color-control" data-color-field="primary">
                <input type="color" value="#64c6a9" aria-label="Выбрать основной цвет" />
                <input type="text" value="#64C6A9" maxlength="9" aria-label="Код цвета" />
              </div>
            </label>
            <label class="theme-form__field">
              <span class="theme-form__label">Акцент</span>
              <div class="theme-color-control" data-color-field="accent">
                <input type="color" value="#cfa0e9" aria-label="Выбрать акцентный цвет" />
                <input type="text" value="#CFA0E9" maxlength="9" aria-label="Код акцентного цвета" />
              </div>
            </label>
            <label class="theme-form__field">
              <span class="theme-form__label">Градиент (от)</span>
              <div class="theme-color-control" data-color-field="gradient_from">
                <input type="color" value="#6366f1" aria-label="Начало градиента" />
                <input type="text" value="#6366F1" maxlength="9" aria-label="Код цвета начала градиента" />
              </div>
            </label>
            <label class="theme-form__field">
              <span class="theme-form__label">Градиент (до)</span>
              <div class="theme-color-control" data-color-field="gradient_to">
                <input type="color" value="#8b5cf6" aria-label="Конец градиента" />
                <input type="text" value="#8B5CF6" maxlength="9" aria-label="Код цвета конца градиента" />
              </div>
            </label>
            <label class="theme-form__field">
              <span class="theme-form__label">Поверхность карт</span>
              <div class="theme-color-control" data-color-field="surface">
                <input type="color" value="#ffffff" aria-label="Цвет карточек" />
                <input type="text" value="#FFFFFF" maxlength="9" aria-label="Код цвета карточек" />
              </div>
            </label>
          </div>
          <div class="theme-presets" data-theme-presets>
            {% for preset in theme_presets %}
            <button type="button" class="theme-presets__item" data-theme-preset='{{ preset | tojson }}'>{{ preset.label }}</button>
            {% endfor %}
          </div>
          <div class="settings-actions">
            <button class="button" type="submit">Сохранить тему</button>
            <button class="button button--ghost" type="button" data-theme-reset>Сбросить к глобальной</button>
          </div>
        </form>
      </section>
    </section>

    {% if is_admin %}
    <section class="settings-section settings-section--admin">
      <header class="settings-section__header">
        <h2 class="settings-section__title">Административные настройки</h2>
        <p class="settings-section__subtitle">Эти параметры видны только администраторам и влияют на всю рабочую область.</p>
      </header>
      <div class="settings-grid settings-grid--admin">
        <section class="settings-card" aria-labelledby="global-theme-title">
          <div class="settings-card__header">
            <h3 id="global-theme-title">Глобальная тема</h3>
            <p>Установите брендовые цвета и режим по умолчанию. Пользователи могут переопределять пресет у себя.</p>
          </div>
          <form id="global-theme-form" class="theme-form" data-theme-layer="global" data-feedback>
            <div class="theme-preview theme-preview--compact" data-theme-preview>
              <div class="theme-preview__gradient" data-theme-gradient></div>
              <div class="theme-preview__content">
                <h4 class="theme-preview__title">Корпоративный стиль</h4>
              </div>
            </div>
            <div class="theme-form__grid">
              <label class="theme-form__field">
                <span class="theme-form__label">Режим по умолчанию</span>
                <select name="mode" data-theme-field>
                  <option value="system">Авто</option>
                  <option value="light">Светлая</option>
                  <option value="dark">Тёмная</option>
                </select>
              </label>
              <label class="theme-form__field">
                <span class="theme-form__label">Основной цвет</span>
                <div class="theme-color-control" data-color-field="primary">
                  <input type="color" value="#64c6a9" aria-label="Основной цвет системы" />
                  <input type="text" value="#64C6A9" maxlength="9" aria-label="Код цвета" />
                </div>
              </label>
              <label class="theme-form__field">
                <span class="theme-form__label">Акцент</span>
                <div class="theme-color-control" data-color-field="accent">
                  <input type="color" value="#cfa0e9" aria-label="Акцент" />
                  <input type="text" value="#CFA0E9" maxlength="9" aria-label="Код цвета" />
                </div>
              </label>
              <label class="theme-form__field">
                <span class="theme-form__label">Градиент (от)</span>
                <div class="theme-color-control" data-color-field="gradient_from">
                  <input type="color" value="#6366f1" aria-label="Начало градиента" />
                  <input type="text" value="#6366F1" maxlength="9" aria-label="Код цвета" />
                </div>
              </label>
              <label class="theme-form__field">
                <span class="theme-form__label">Градиент (до)</span>
                <div class="theme-color-control" data-color-field="gradient_to">
                  <input type="color" value="#8b5cf6" aria-label="Конец градиента" />
                  <input type="text" value="#8B5CF6" maxlength="9" aria-label="Код цвета" />
                </div>
              </label>
              <label class="theme-form__field">
                <span class="theme-form__label">Поверхность</span>
                <div class="theme-color-control" data-color-field="surface">
                  <input type="color" value="#ffffff" aria-label="Цвет поверхностей" />
                  <input type="text" value="#FFFFFF" maxlength="9" aria-label="Код цвета" />
                </div>
              </label>
            </div>
            <div class="theme-presets" data-theme-presets>
              {% for preset in theme_presets %}
              <button type="button" class="theme-presets__item" data-theme-preset='{{ preset | tojson }}'>{{ preset.label }}</button>
              {% endfor %}
            </div>
            <div class="settings-actions">
              <button class="button" type="submit">Сохранить глобальную тему</button>
              <button class="button button--ghost" type="button" data-theme-reset>Сбросить к стандарту</button>
            </div>
          </form>
        </section>

        <section class="settings-card" aria-labelledby="branding-settings-title">
          <div class="settings-card__header">
            <h3 id="branding-settings-title">Брендинг</h3>
            <p>Обновите копирайт и публичные ссылки — изменения вступают в силу мгновенно.</p>
          </div>
          <form id="branding-form" class="settings-form" data-feedback>
            <label class="settings-field">Имя бренда<input class="control" type="text" name="BRAND_NAME" value="{{ BRAND_NAME }}" autocomplete="organization"></label>
            <label class="settings-field">Публичный URL<input class="control" type="url" name="PUBLIC_URL" value="{{ PUBLIC_URL }}" autocomplete="url" placeholder="https://intdata.pro"></label>
            <label class="settings-field">URL бота<input class="control" type="url" name="BOT_LANDING_URL" value="{{ BOT_LANDING_URL }}" autocomplete="url"></label>
            <div class="settings-actions">
              <button class="button" type="submit">Сохранить брендинг</button>
            </div>
          </form>
        </section>

        <section class="settings-card" aria-labelledby="telegram-settings-title">
          <div class="settings-card__header">
            <h3 id="telegram-settings-title">Telegram интеграции</h3>
            <p>Управляйте авторизацией через Telegram и обновляйте токен бота без перезапуска.</p>
          </div>
          <form id="telegram-form" class="settings-form" data-feedback>
            <label class="settings-checkbox settings-checkbox--inline">
              <input type="checkbox" name="TG_LOGIN_ENABLED" {% if TG_LOGIN_ENABLED %}checked{% endif %}>
              <span>Включить Telegram Login</span>
            </label>
            <label class="settings-field">Имя бота (без @)<input class="control" type="text" name="TG_BOT_USERNAME" value="{{ TG_TG_BOT_USERNAME or '' }}" autocomplete="off"></label>
            <label class="settings-field">Новый токен бота<input class="control" type="password" name="TG_BOT_TOKEN" placeholder="Задать новый токен" autocomplete="off"></label>
            <div class="settings-actions settings-actions--split">
              <button class="button" type="submit">Сохранить Telegram настройки</button>
              <div class="settings-actions__group">
                <button class="button button--ghost" type="button" data-restart="web">Рестарт веба</button>
                <button class="button button--ghost" type="button" data-restart="bot">Рестарт бота</button>
              </div>
            </div>
          </form>
        </section>

        <section class="settings-card settings-card--templates" aria-labelledby="settings-templates-title">
          <div class="settings-card__header">
            <h3 id="settings-templates-title">Заготовки будущих настроек</h3>
            <p>Используйте этот блок при добавлении новых административных параметров: вёрстка и стили уже готовы.</p>
          </div>
          <div class="template-grid">
            <article class="template-tile">
              <h4>Пресеты уведомлений</h4>
              <p>Добавьте переключатели и селекты для настройки частоты уведомлений.</p>
              <div class="template-tile__placeholder"></div>
            </article>
            <article class="template-tile">
              <h4>Интеграции</h4>
              <p>Карточка с toggles, списком вебхуков и CTA «Добавить интеграцию».</p>
              <div class="template-tile__placeholder"></div>
            </article>
          </div>
        </section>
      </div>
    </section>
    {% endif %}
  </main>
</div>
<script type="module" src="{{ url_for('static', path='js/settings-page.js') }}"></script>
{% endblock %}
