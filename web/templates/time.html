{% extends "base.html" %}
{% block title %}Учёт времени{% endblock %}
{% block content %}
<div class="ui-layout">
  <div id="main-content">
    <div class="ui-notice">Запускайте таймер и отслеживайте работу.</div>

    <section class="card" style="margin-bottom:1rem;">
      <div class="card-title">Фильтры</div>
      <div class="ui-form" id="time-filters">
        <label>
          <div>Область</div>
          <select id="time-filter-area"></select>
        </label>
        <label style="align-self:flex-end;">
          <input type="checkbox" id="time-filter-include-sub"/> Включая подкатегории
        </label>
        <button class="button" id="time-filter-apply">Показать</button>
      </div>
    </section>

    <section class="card" style="margin-bottom:1rem;">
      <div class="card-title">Старт таймера</div>
      <form id="time-form" class="ui-form">
        <label>
          <div>Описание</div>
          <input type="text" name="description" placeholder="Что делаете?">
        </label>
        <label>
          <div>ID задачи (необязательно)</div>
          <input type="number" name="task_id" placeholder="Напр.: 42" min="1">
        </label>
        <button class="button" type="submit">Старт</button>
      </form>
    </section>

    <section class="card">
      <div class="card-title">Записи времени</div>
      <table class="ui-table">
        <thead><tr><th>ID</th><th>Задача</th><th>Начало</th><th>Конец</th><th>Описание</th><th></th></tr></thead>
        <tbody id="time-list"></tbody>
      </table>
      <div id="time-empty" class="text-muted" style="display:none; padding:8px;">Записей пока нет</div>
    </section>
  </div>
</div>

<script>
async function fetchEntries(){
  const sel = document.getElementById('time-filter-area');
  const area = sel && sel.value ? Number(sel.value) : null;
  const include = document.getElementById('time-filter-include-sub')?.checked ? 1 : 0;
  const qs = new URLSearchParams(); if (area) qs.set('area_id', String(area)); if (area && include) qs.set('include_sub','1');
  const resp = await fetch('/api/v1/time' + (qs.toString()? ('?'+qs.toString()):''), {credentials:'include'});
  if (!resp.ok){
    const empty = document.getElementById('time-empty');
    empty.textContent = 'Требуется вход и связанный Telegram-аккаунт';
    empty.style.display='block';
    return;
  }
  const data = await resp.json();
  const list = document.getElementById('time-list');
  list.innerHTML = '';
  if (!data.length){
    document.getElementById('time-empty').style.display='block';
    return;
  }
  document.getElementById('time-empty').style.display='none';
  for (const t of data){
    const start = new Date(t.start_time).toLocaleString();
    const end = t.end_time ? new Date(t.end_time).toLocaleString() : '';
    const stopBtn = end ? '' : `<button class="button" data-action="stop" data-id="${t.id}">Стоп</button>`;
    const resumeBtn = end && t.task_id ? `<button class="button" data-action="resume" data-task="${t.task_id}">Продолжить</button>` : '';
    const tr = document.createElement('tr');
    const taskCell = t.task_id ? `#${t.task_id}` : '';
    tr.innerHTML = `<td>${t.id}</td><td>${taskCell}</td><td>${start}</td><td>${end}</td><td>${t.description || ''}</td><td>${stopBtn} ${resumeBtn}</td>`;
    list.appendChild(tr);
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  (async ()=>{ const resp = await fetch('/api/v1/areas', {credentials:'include'}); if (!resp.ok) return; const areas = await resp.json(); areas.sort((a,b)=> (a.mp_path||'').localeCompare(b.mp_path||'')); const sel = document.getElementById('time-filter-area'); if (sel){ sel.innerHTML='<option value="">— не выбрано —</option>'; for (const a of areas){ const opt=document.createElement('option'); opt.value=a.id; opt.textContent='— '.repeat(a.depth||0)+a.name; sel.appendChild(opt);} }})();
  document.getElementById('time-filter-apply').addEventListener('click', (e)=>{ e.preventDefault(); fetchEntries(); });
  const form = document.getElementById('time-form');
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const taskIdRaw = fd.get('task_id');
    const payload = {description: fd.get('description') || null, task_id: taskIdRaw ? Number(taskIdRaw) : null};
    const resp = await fetch('/api/v1/time/start', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify(payload)
    });
    if (resp.ok){ form.reset(); fetchEntries(); }
  });
  fetchEntries();
});

document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-action="stop"]');
  if (!btn) return;
  const id = btn.dataset.id;
  const resp = await fetch(`/api/v1/time/${id}/stop`, {method:'POST', credentials:'include'});
  if (resp.ok){ fetchEntries(); }
});
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-action="resume"]');
  if (!btn) return;
  const taskId = btn.dataset.task;
  const resp = await fetch(`/api/v1/time/resume/${taskId}`, {method:'POST', credentials:'include'});
  if (resp.ok){ fetchEntries(); }
});
</script>
{% endblock %}
