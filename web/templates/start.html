{% extends "base.html" %}
{% block title %}ЦУП{% endblock %}

{% block content %}
  <div class="has-dashboard">
    <div class="dashboard-toolbar">
      <button type="button" class="button button--ghost" data-dashboard-edit aria-pressed="false">
        Настроить дашборд
      </button>
    </div>
    <div class="dashboard-editor-panel" data-dashboard-editor hidden>
      <div class="dashboard-editor-panel__title">Скрытые виджеты</div>
      <ul class="dashboard-editor-panel__list" data-dashboard-hidden-list></ul>
    </div>
    <div class="dashboard" data-dashboard>

      {# — Профиль #}
      <section class="card span-2 profile-widget" id="card-profile" data-widget="profile_card">
          <div class="profile-header">
            <div class="profile-avatar" aria-hidden="true">
              <svg class="icon-lg"><use href="#i-user"/></svg>
            </div>
            <div class="profile-name">
              <div class="title">{{ profile_user.full_name or profile_user.username }}</div>
              <div class="muted">@{{ profile_user.username }}</div>
            </div>
            {# роль скрыта из UI #}
          </div>

        <div class="profile-grid">
            <div class="item">
              <div class="label label-with-icon">
                <svg class="icon icon-muted"><use href="#i-mail"/></svg>
                <span>Email</span>
              </div>
              <div class="value">
                {% if profile_user.email %}
                  <a class="profile-link" href="mailto:{{ profile_user.email }}">{{ profile_user.email }}</a>
                {% else %}
                  <span class="ui2-muted">не указано</span>
                {% endif %}
              </div>
            </div>

            <div class="item">
              <div class="label label-with-icon">
                <svg class="icon icon-muted"><use href="#i-phone"/></svg>
                <span>Телефон</span>
              </div>
              <div class="value">
                {% if profile_user.phone %}
                  {% set tel_clean = profile_user.phone
                      |replace(' ', '')
                      |replace('(', '')
                      |replace(')', '')
                      |replace('-', '') %}
                  <a class="profile-link" href="tel:{{ tel_clean }}">{{ profile_user.phone }}</a>
                {% else %}
                  <span class="ui2-muted">не указан</span>
                {% endif %}
              </div>
            </div>

            <div class="item">
              <div class="label label-with-icon">
                <svg class="icon icon-muted"><use href="#i-cake"/></svg>
                <span>День рождения</span>
              </div>
              <div class="value">
                {{ profile_user.birthday.strftime('%d.%m.%Y') if profile_user.birthday else 'не указано' }}
              </div>
            </div>

            <div class="item">
              <div class="label label-with-icon">
                <svg class="icon icon-muted"><use href="#i-globe"/></svg>
                <span>Язык</span>
              </div>
              <div class="value">{{ profile_user.language or 'не указан' }}</div>
            </div>
        </div>

        <div class="profile-actions">
          <a class="button" href="/profile/{{ profile_user.username }}">Подробнее</a>
        </div>
      </section>

      {# — Таймлайн дня #}
      {% set events = day_timeline or [] %}
      <section class="card span-2" data-widget="today">
        <div class="card-title">Сегодня</div>
        <div class="timeline">
          {% for event in events %}
          <div class="timeline-row">
            <div class="time">{{ event.time }}</div>
            <div class="dot"></div>
            <div class="text">{{ event.text }}</div>
          </div>
          {% else %}
          <div class="text-muted">Нет событий</div>
          {% endfor %}
        </div>
      </section>

      <section class="card" data-href="/notes" data-widget="quick_note">
        <div class="card-title">Заметки</div>
        <form id="quick-note-form" class="stack gap-2">
          <textarea name="content" rows="3" placeholder="Быстрая заметка..." required></textarea>
          <div class="row gap-2">
            <button class="btn btn-primary" type="submit">Сохранить</button>
          </div>
        </form>
        <div id="quick-note-result" class="muted" hidden>Сохранено</div>
      </section>

      {# — KPI ряд: примеры (могут прийти из контекста) #}
      {% set delta = kpi_focus_week_delta or 0 %}
      <section class="card" data-widget="focus_week">
        <div class="card-title">Фокус за неделю</div>
        <div class="kpi">
          <div>
            <div class="label text-muted">Часы</div>
            <div class="value">{{ kpi_focus_week or "0ч" }}</div>
          </div>
          {% if delta is defined %}
          <div class="delta {% if delta >= 0 %}up{% else %}down{% endif %}">
            {{ delta|round(2) }}%
          </div>
          {% endif %}
        </div>
      </section>

      {% set delta = kpi_goals_delta or 0 %}
      <section class="card" data-widget="goals">
        <div class="card-title">Достижения</div>
        <div class="kpi">
          <div>
            <div class="label text-muted">Выполнено целей</div>
            <div class="value">{{ kpi_goals or "0" }}</div>
          </div>
          {% if delta is defined %}
          <div class="delta {% if delta >= 0 %}up{% else %}down{% endif %}">
            {{ delta|round(2) }}%
          </div>
          {% endif %}
        </div>
      </section>

      {% set delta = kpi_focused_hours_delta or 0 %}
      <section class="card" data-widget="focused_hours">
        <div class="card-title">Сфокусированные часы</div>
        <div class="kpi">
          <div>
            <div class="label text-muted">Всего</div>
            <div class="value">{{ kpi_focused_hours or "0ч" }}</div>
          </div>
          {% if delta is defined %}
          <div class="delta {% if delta >= 0 %}up{% else %}down{% endif %}">
            {{ delta|round(2) }}%
          </div>
          {% endif %}
        </div>
      </section>

      {% set delta = kpi_health_delta or 0 %}
      <section class="card" data-widget="health">
        <div class="card-title">Здоровье</div>
        <div class="kpi">
          <div>
            <div class="label text-muted">Health score</div>
            <div class="value">{{ kpi_health or "—" }}</div>
          </div>
          {% if delta is defined %}
          <div class="delta {% if delta >= 0 %}up{% else %}down{% endif %}">
            {{ delta|round(2) }}%
          </div>
          {% endif %}
        </div>
      </section>

      {# — Графики/плейсхолдеры #}
      <section class="card span-2" data-widget="activity">
        <div class="card-title">Активность по дням</div>
        <div class="chart-placeholder"></div>
      </section>
      <section class="card span-2" data-widget="energy">
        <div class="card-title">Сон / энергия</div>
        <div class="chart-placeholder"></div>
      </section>

      {# — Группы и проекты #}
      {% set groups_owned = owned_groups|map(attribute='title')|list %}
      {% set groups_items = groups_owned|map('string')|list %}
      {% set items = owned_groups or [] %}
      <section class="card" data-widget="leader_groups">
        <div class="card-title">Руководите группами</div>
        <div class="list">
          {% for item in items %}
          <div class="list-item">
            <div class="title">{{ item.title }}</div>
            {% if item.subtitle %}<div class="subtitle text-muted">{{ item.subtitle }}</div>{% endif %}
          </div>
          {% else %}
          <div class="text-muted">Пока пусто</div>
          {% endfor %}
        </div>
      </section>

      {% set items = member_groups or [] %}
      <section class="card" data-widget="member_groups">
        <div class="card-title">Состоите в группах</div>
        <div class="list">
          {% for item in items %}
          <div class="list-item">
            <div class="title">{{ item.title }}</div>
            {% if item.subtitle %}<div class="subtitle text-muted">{{ item.subtitle }}</div>{% endif %}
          </div>
          {% else %}
          <div class="text-muted">Пока пусто</div>
          {% endfor %}
        </div>
      </section>

      {% set overview = group_moderation_overview or [] %}
      <section class="card span-2" data-widget="group_moderation">
        <div class="card-title">Модерация групп</div>
        <div class="list">
          {% for item in overview %}
          <div class="list-item">
            <div class="title">{{ item.title }}</div>
            <div class="subtitle text-muted">
              Активны: {{ item.active }}/{{ item.members }} · Без оплаты: {{ item.unpaid }} · Тихие: {{ item.quiet }} · Последняя активность: {{ item.last_activity }}
            </div>
          </div>
          {% else %}
          <div class="text-muted">Данные появятся после подключения групп.</div>
          {% endfor %}
        </div>
        <footer class="card-footer">
          <a href="/groups" class="link-muted">Перейти к управлению группами</a>
        </footer>
      </section>

      {% set items = owned_projects or [] %}
      <section class="card" data-widget="owned_projects">
        <div class="card-title">Ваши проекты</div>
        <div class="list">
          {% for item in items %}
          <div class="list-item">
            <div class="title">{{ item.title }}</div>
            {% if item.subtitle %}<div class="subtitle text-muted">{{ item.subtitle }}</div>{% endif %}
          </div>
          {% else %}
          <div class="text-muted">Пока пусто</div>
          {% endfor %}
        </div>
      </section>

      {% set items = member_projects or [] %}
      <section class="card" data-widget="member_projects">
        <div class="card-title">Участвуете в проектах</div>
        <div class="list">
          {% for item in items %}
          <div class="list-item">
            <div class="title">{{ item.title }}</div>
            {% if item.subtitle %}<div class="subtitle text-muted">{{ item.subtitle }}</div>{% endif %}
          </div>
          {% else %}
          <div class="text-muted">Пока пусто</div>
          {% endfor %}
        </div>
      </section>

      {# — Виджеты следующих этапов разработки #}
      {% set items = upcoming_tasks or [] %}
      <section class="card" data-href="/tasks" data-widget="upcoming_tasks">
        <div class="card-title">Предстоящие задачи</div>
        <div class="list">
          {% for item in items %}
          <div class="list-item">
            <div class="title">{{ item.title }}</div>
            {% if item.subtitle %}<div class="subtitle text-muted">{{ item.subtitle }}</div>{% endif %}
          </div>
          {% else %}
          <div class="text-muted">Нет задач</div>
          {% endfor %}
        </div>
      </section>

      {% set items = upcoming_alarms or [] %}
      <section class="card" data-href="/calendar" data-widget="reminders">
        <div class="card-title">Напоминания</div>
        <div class="list">
          {% for item in items %}
          <div class="list-item">
            <div class="title">{{ item.title }}</div>
            {% if item.subtitle %}<div class="subtitle text-muted">{{ item.subtitle }}</div>{% endif %}
          </div>
          {% else %}
          <div class="text-muted">Нет напоминаний</div>
          {% endfor %}
        </div>
      </section>

      {% set items = upcoming_events or [] %}
      <section class="card" data-href="/calendar" data-widget="next_events">
        <div class="card-title">Ближайшие события</div>
        <div class="list">
          {% for item in items %}
          <div class="list-item">
            <div class="title">{{ item.title }}</div>
            {% if item.subtitle %}<div class="subtitle text-muted">{{ item.subtitle }}</div>{% endif %}
          </div>
          {% else %}
          <div class="text-muted">Нет событий</div>
          {% endfor %}
        </div>
      </section>

      {% set items = habit_list or [] %}
      <section class="card" data-widget="habits">
        <div class="card-title">Привычки</div>
        <div class="list">
          {% for item in items %}
          <div class="list-item">
            <div class="title">{{ item.title }}</div>
            <div class="habit-progress"><div style="width: {{ item.percent }}%"></div></div>
            <div class="subtitle text-muted">{{ item.percent }}%</div>
          </div>
          {% else %}
          <div class="text-muted">Нет данных</div>
          {% endfor %}
        </div>
      </section>

    </div>
    {% if is_admin and admin_iframe_src %}
      {% set anchor = admin_anchor_id if admin_anchor_id is defined and admin_anchor_id else 'cup-admin-tools' %}
      <section id="{{ anchor }}" class="cup-admin cup-admin--iframe">
        <header class="cup-admin__header">
          <h2 class="cup-admin__title">Админский сектор</h2>
          {% if admin_heading_description %}
          <p class="cup-admin__description">{{ admin_heading_description }}</p>
          {% endif %}
        </header>
        <div class="cup-admin__iframe-wrap">
          <iframe
            src="{{ admin_iframe_src }}"
            title="Админский сектор"
            data-admin-iframe
            loading="lazy"
            referrerpolicy="same-origin"
          ></iframe>
        </div>
      </section>
    {% endif %}
  </div>
{% endblock %}
