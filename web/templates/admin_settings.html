{% extends "base.html" %}
{% block title %}Настройки{% endblock %}
{% block content %}
<div class="ui-layout">
  <div id="main-content">
    <section class="card" style="margin-bottom:1rem;">
      <div class="card-title">Брендинг</div>
      <form id="branding-form" class="ui-form">
        <label>Имя бренда<input class="control" type="text" name="BRAND_NAME" value="{{ BRAND_NAME }}"></label>
        <label>Публичный URL<input class="control" type="url" name="PUBLIC_URL" value="{{ PUBLIC_URL }}"></label>
        <label>URL бота<input class="control" type="url" name="BOT_LANDING_URL" value="{{ BOT_LANDING_URL }}"></label>
        <button class="button" type="submit">Сохранить</button>
      </form>
    </section>

    <section class="card">
      <div class="card-title">Telegram</div>
      <form id="telegram-form" class="ui-form">
        <label><input type="checkbox" name="TG_LOGIN_ENABLED" {% if TG_LOGIN_ENABLED %}checked{% endif %}> Включить Telegram Login</label>
        <label>Имя бота (без @)<input class="control" type="text" name="TG_BOT_USERNAME" value="{{ TG_TG_BOT_USERNAME or '' }}"></label>
        <label>Токен бота<input class="control" type="password" name="TG_BOT_TOKEN" placeholder="Задать новый токен"></label>
        <button class="button" type="submit">Сохранить</button>
      </form>
    </section>
  </div>
</div>

<script>
const B = window.API_BASE;
async function patch(url, data){
  const resp = await fetch(url, {method:'PATCH', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(data)});
  if (!resp.ok){ alert('Ошибка сохранения'); }
}
document.getElementById('branding-form')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.currentTarget);
  await patch(`${B}/admin/settings/branding`, {
    BRAND_NAME: fd.get('BRAND_NAME'),
    PUBLIC_URL: fd.get('PUBLIC_URL'),
    BOT_LANDING_URL: fd.get('BOT_LANDING_URL'),
  });
  location.reload();
});
document.getElementById('telegram-form')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.currentTarget);
  await patch(`${B}/admin/settings/telegram`, {
    TG_LOGIN_ENABLED: !!fd.get('TG_LOGIN_ENABLED'),
    TG_BOT_USERNAME: (fd.get('TG_BOT_USERNAME')||'').toString().trim() || null,
    TG_BOT_TOKEN: (fd.get('TG_BOT_TOKEN')||'').toString().trim() || null,
  });
  location.reload();
});
</script>
{% endblock %}

