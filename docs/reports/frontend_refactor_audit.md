# Аудит рефакторинга фронтенда (Next.js)

Дата: 17 сентября 2025
Подготовил: автоматизированный аудит (Codex)

## 1. Краткое резюме

Рефакторинг фронтенда перевёл публичные модульные страницы на стек Next.js + TypeScript + Tailwind и обеспечил единый AppShell. При этом часть инфраструктурных задач осталась незавершённой: сборка Next.js выполняется лениво на первом HTTP-запросе, архитектура UI смешивает новый React-рендер и legacy-шаблоны, тестовое покрытие ограничено unit-уровнем, отсутствуют единые DevOps-практики для доставки новых билдов. Без устранения этих разрывов рефакторинг остаётся хрупким и не отвечает целям E17 «Frontend Modernization».

## 2. Контекст и область аудита

- **Цель:** оценить текущее состояние рефакторинга фронтенда (Next.js App Router) и выявить расхождения с лучшими практиками 2025 года.
- **Объём:** каталог `web/` (Next.js проект), интеграция с FastAPI (`web/routes/index.py`), build-цепочка (`package.json`, GitHub scripts), tailwind-конфигурация, компонентные и UI-тесты.
- **Не покрыто:** бизнес-логика в `core/`, Telegram-бот, Jinja-шаблоны, которые ещё не мигрировали.

## 3. Сводка текущего состояния

| Аспект | Состояние |
| --- | --- |
| Стек | Next.js 15 (App Router) + TypeScript + Tailwind + React Query (`web/app`, `web/components`). |
| Роутинг | AppShell, страницы `/` / `/inbox` / `/areas` / `/projects` / `/resources` / `/tasks` / `/users` реализованы через React-компоненты (`web/app/**/page.tsx`). |
| Интеграция с бэкендом | REST через `apiFetch` (`web/lib/api.ts`), cookie-based сессия. В FastAPI добавлены роуты, отдающие собранный HTML/статик (`web/routes/index.py:289`). |
| Сборка | `npm run build` + `npm run lint` + `npm test` (Vitest). Автоматическая сборка вызывается на первом HTTP-запросе, если артефакты отсутствуют. |
| CSS и дизайн-токены | Tailwind + кастомные переменные в AppShell, общие токены в `globals.css`. |
| Тесты | Vitest-юниты на компоненты (таблицы, страницы). Нет e2e / визуальных тестов. |
| Документация | README в `web/` минимальный, E17 в `docs/BACKLOG.md` описывает задачи, но фактические шаги рефакторинга не задокументированы. |

## 4. Сильные стороны

- **Единый каркас UI:** AppShell и PageLayout дают консистентную навигацию и дизайн (`web/components/AppShell.tsx`).
- **Современный стек:** Next.js App Router, React Query, TypeScript – хороший фундамент для дальнейшей модернизации (соответствует E17).
- **Компонентное покрытие тестами:** для ключевых таблиц и каталогов присутствуют Vitest-тесты (например, `web/components/users/UsersCatalog.test.tsx`).
- **Tailwind + дизайн-токены:** классическая связка, поддерживает адаптив.

## 5. Риски и проблемы

### 5.1 Инфраструктура и поставка

1. **Ленивая сборка в runtime.** FastAPI при первом обращении к `/users`/`/_next/static` запускает `npm ci`/`npm run build` (`web/routes/index.py:289`). Это блокирует запрос, требует установленного Node на проде и может упасть под нагрузкой. Best practice – собирать артефакты при CI/CD и доставлять как часть релиза.
2. **Отсутствует `next.config.js` / стратегия импорта изображений.** Нет явного файла конфигурации Next.js. Настройки изображений, headers, rewrites и пр. управлять некуда (риск безопасности и производительности).
3. **Tailwind контент указывает и на legacy-шаблоны.** Конфиг (`web/tailwind.config.js`) сканирует `./templates/**/*.html`, что тормозит build, мешает tree-shaking и закрепляет зависимость от Jinja.
4. **Нет разделения окружений для API.** `apiFetch` использует `NEXT_PUBLIC_API_BASE`/`API_URL`, но отсутствует `.env.production` пример. Сборка зависит от переменных окружения, не задокументировано.

### 5.2 Архитектура и кодовая база

1. **Смешение Next.js и legacy шаблонов.** Большая часть UI ещё рендерится Jinja (`web/templates`). Нужно план миграции, иначе поддержка двойной системы продолжится.
2. **Автоматический build в runtime не очищает кэш.** При успешном build `_load_next_html` закеширован с `lru_cache`, но не инвалидируется при обновлении. После деплоя без рестарта можно получить устаревший HTML.
3. **Отсутствует слой типизированных API-клиентов.** `apiFetch` бросает `ApiError`, но нет typed hooks / zod-схем для ответов (коды, пагинация). Ошибки обрабатываются ad-hoc.
4. **Повсеместное `use client`.** Многие компоненты объявлены клиентскими, хотя могут быть серверными (например, страницы `web/app/users/page.tsx`). Это мешает SSR и производительности.

### 5.3 UI/UX и доступность

1. **Нет системы дизайна/компонентной библиотеки.** Набор компонентов разрозненный, отсутствуют централизованные токены, нет UI-kit (кроме глобальных className). Лучшие практики 2025 подразумевают дизайн-систему.
2. **Не покрыты ключевые пользовательские сценарии.** `/users` испытывает 307 redirect без cookie `web_user_id`. Для публичной витрины («каталог пользователей») нужен guest-view.
3. **Отсутствует аналитика по CWV.** Нет интеграции с Lighthouse или Web Vitals, нет сборки критического CSS.

### 5.4 Тестирование и DX

1. **Только unit-тесты.** Нет интеграционных/визуальных тестов (Playwright, Loki). Сложно поймать регрессии в верстке.
2. **Нет линтеров для CSS/Accessibility.** Только ESLint + Prettier. Нет Stylelint, нет axe-тестов.
3. **CI пайплайн Next.js не зафиксирован.** В репозитории отсутствуют скрипты/док, описывающие запуск lint/test/build перед деплоем.

### 5.5 Документация и контроль изменений

1. **README/web минимален.** Нет инструкции по запуску Next.js, переменных окружения, структуре каталогов.
2. **E17 в BACKLOG не синхронизирован с фактическими задачами.** Остались незакрытые элементы (очистка legacy, roadmap).
3. **Нет changelog’а для фронтенд-бандла.** `docs/CHANGELOG.md` содержит общие записи, но отсутствие отдельного раздела для Web усложняет отслеживание изменений.

## 6. Рекомендации

### Высокий приоритет (до ближайшего релиза)

1. **Перенести сборку Next.js в CI/CD.**
   - Добавить job `npm ci && npm run lint && npm test && npm run build`.
   - Публиковать сборочный артефакт (`/.next/`) в Docker image или объектное хранилище.
   - Удалить runtime-сборку, заменить на простую отдачу статичного каталога.
2. **Описать процесс запуска фронтенда.** Расширить `web/readme.md` (setup, env, режимы dev/prod).
3. **Реализовать гостевой просмотр `/users`.** Перевести API на public audience, добавить graceful fallback.

### Средний приоритет

1. **Стандартизировать конфигурацию Next.js.** Создать `next.config.mjs` (i18n, headers, images, SVGR, bundle analyzer). Настроить `experimental` флаги (Server Actions, Turbopack) по roadmap.
2. **Перенести Tailwind на фронтенд-источники.** В `tailwind.config.js` оставить пути `./app`, `./components`, `./ui`, убрать `templates` после миграции.
3. **Снизить количество клиентских компонентов.** Перевести страницы и «чистые» компоненты на серверный рендер, оставляя клиентский только для интерактивных элементов.
4. **Добавить Storybook/Chromatic или аналог.** Для визуальных регрессий и UI review.

### Низкий приоритет / стратегические шаги

1. **Миграция legacy-шаблонов.** Составить план по переносу Jinja страниц (notes, settings, admin) в Next.js (под-эпик E17b).
2. **Интеграция с дизайн-системой.** Внедрить tokens (CSS variables), компонентную библиотеку (например, Radix) и документацию.
3. **Отчетность по CWV.** Настроить автоматический Lighthouse / Web Vitals мониторинг.
4. **Документировать Guidelines UI 2025.** В `docs/reports` подготовить playbook по современным паттернам (animations, motion, a11y) и применять к новым страницам.

## 7. Предлагаемый roadmap (в связке с BACKLOG E17)

1. **Спринт 1 (P0):** CI/CD сборка, документация по запуску, harden `/users` для гостей.
2. **Спринт 2 (P1):** Tailwind cleanup, next.config, Storybook, аудит клиентских компонентов.
3. **Спринт 3 (P2):** Миграция очередных legacy-страниц, интеграция дизайн-системы, Lighthouse pipeline.

## 8. Приложения

- Стек и структура: `web/app/**`, `web/components/**`, `web/routes/index.py` (интеграция), `web/lib/**` (API утилиты).
- Скрипты: `package.json` (`dev`, `build`, `lint`, `test`).
- Тесты: Vitest (`web/components/**/*.test.tsx`).
- Tailwind: `web/tailwind.config.js` – требует актуализации путей.
