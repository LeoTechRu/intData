# Conventions Catalog

Здесь фиксируются правила разработки и документирования, которые выводятся из `vision.md`, исторических решений и lessons learned. Файл служит единой точкой правды для стайлгайдов всего репозитория.

## Как пользоваться
1. Перед началом задачи прочитайте соответствующий раздел.
2. Если в ходе работы возникает необходимость обновить правила — обсудите в `vision.md`, затем отразите обновление здесь, приложив ссылку на решение.
3. При код-ревью и автоматических проверках ссылайтесь на конкретные пункты `conventions.md`.

## Разделы (шаблон)
- **Git & ветки** — формат веток, коммитов, PR.
- **Документация** — как вести idea/vision/tasklist/guides.
- **Фронтенд** — стайлгайд Next.js, React, Tailwind.
- **Бэкенд** — Python, FastAPI, SQL.
- **Тесты** — уровни, инструменты, naming.
- **Инфраструктура** — деплой, конфигурации, observability.

*(Наполните разделы по мере утверждения правил.)*

## Фронтенд
- Используем компонент `TermHint` для пояснения непонятных терминов (slug, Telegram ID, CRM-метрики и др.). Любой новый UI обязан добавлять тултип, если термин не очевиден основной аудитории.
- Кнопки связи с техподдержкой и разработчиком отображаем только при наличии соответствующего тарифа (см. `AppShell`: флаги `hasPaidSupport` и `hasDeveloperContact`).
- Плашку с ролью пользователя в `AppShell` показываем только на ширинах `lg` и шире, чтобы мобильная шапка не ломалась; на узких экранах оставляем аватар и имя.
- Редактор дашборда (перетаскивание и палитра виджетов) доступен только на десктопе (`min-width: 768px`); на мобильных отображаем статичную сетку без управляющих кнопок.
- Боковая навигация AppShell строится по секциям (Пульт, Календарь, Задачи, Знания, Команда, Администрирование) с одноуровневыми списками. Секции могут сворачиваться, но скрытые пункты остаются в редакторе; источником правды служит `NAV_BLUEPRINT` (см. vision «Modular Navigation»).
- Всё левое меню — избранные страницы пользователя: каждый пункт присутствует в единственном экземпляре и может быть только показан или скрыт. Звёздочка в заголовке управляет видимостью пункта и синхронизируется с редактором навигации.
- Для модулей с несколькими страницами добавляем верхние вкладки `ModuleTabs`, которые адаптируются под ширины 360–1440 px и позволяют переходить между связанным функционалом без изменения контекста.
- Модуль `/crm` строится на Next.js App Router: корень редиректит на `/crm/products`, страницы `/crm/deals`, `/crm/accounts`, `/crm/analytics` подключают отдельные модули из `web/components/crm`. Продукты, тарифы и потоки визуализируются внутри одного layout с drag-free карточками и формой переходов.
- Страница `/products` стала прокси на `/crm/products`; любые новые настройки для каталога добавляем в CRM-модуль, а не в legacy-каталог.
- Поле входа в форме авторизации автоматически определяет режим (`username`/`email`/`phone`) по вводу: используем единый `<input>` с обработчиком и подсказкой «автоопределение по вводу». Placeholders и `autoComplete` переключаются синхронно.

## Бэкенд
- Контакт в CRM создаём в `users_web`: имя пользователя опциональное, но email или телефон обязателен. В БД действует чек `users_web_contact_present` (username OR email OR phone).
- Новые таблицы CRM (`crm_products`, `crm_product_versions`, `crm_product_tariffs`, `crm_accounts`, `crm_deals`, `crm_touchpoints`, `crm_subscriptions`, `crm_subscription_events`) обязательно сохраняют PARA-контекст (`project_id` или `area_id`), поле `config/context` хранит доп. метаданные в формате JSONB.
- Сервис `CRMService` — фасад для CRUD по продуктам, тарифам, потокам, аккаунтам, сделкам и подпискам. Любые новые операции (upgrade/downgrade, события таймлайна) реализуем через него, чтобы Telegram-бот и веб использовали единый слой.
- API `/api/v1/crm/products` возвращает продукты с тарифами и потоками; запросы пишем через React Query. Переходы между тарифами выполняются POST `/api/v1/crm/subscriptions/transition` c `transition_type` (`free|upgrade|downgrade`).
