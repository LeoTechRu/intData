Директория для внутренней документации проекта.

# Areas: иерархия сфер ответственности

Areas — управляемое дерево без ограничения глубины. Примеры: «Здоровье → Фитнес → Силовые», «Работа → Клиенты → Проект X».

- Проекты и задачи привязываются к листьям дерева (конечным узлам). Это упрощает отчёты: время и прогресс агрегируются снизу вверх.
- Фильтры поддерживают режим «Включая подкатегории»: можно смотреть задачи/время как по отдельной подветке, так и по всему направлению.
- Перемещение узла меняет путь `mp_path` у всех потомков; ссылки и данные сохраняются (архитектура без жёсткой FK на путь).

Совет: держите дерево компактным. Создавайте подкатегории только когда появляется повторяющийся объём задач и заметок, требующий отдельного фокуса.


# Как получить `chat_id` Telegram-группы

1. Создайте или выберите существующую группу в Telegram.
2. Добавьте в неё своего бота — по username из переменной `TG_BOT_USERNAME`.
3. Сделайте бота администратором, чтобы он мог отправлять сообщения.
4. Получите `chat_id` одним из способов:
   - Напишите любое сообщение в группу и выполните запрос:
     `https://api.telegram.org/bot<TG_BOT_TOKEN>/getUpdates`.
   - В ответе найдите поле `chat` → `id` (будет отрицательным числом).
5. Используйте полученный `chat_id` в настройках канала, например при вызове
   `POST /api/v1/projects/{id}/notifications`.

## Deployment Notes / Troubleshooting

### Troubleshooting /habits

**Симптом:** страница `/habits` показывает «Требуется вход и связанный Telegram» при активной сессии.

**Причина:** маршруты использовали `get_current_tg_user`, игнорируя веб‑сессию пользователя.

**Решение:** новый резолвер `get_current_owner` обрабатывает куки веб‑пользователя и привязку Telegram. Страница `/habits` всегда возвращает `200 OK`, но действия записи требуют привязку и отвечают `403 tg_link_required`.

**UI:** при ответе `429` клиент показывает уведомление «Кулдаун: повторите через N сек.» и временно блокирует кнопки.

### Habit.area AttributeError

На некоторых окружениях страница [/habits] приводила к `AttributeError: type object 'Habit' has no attribute 'area'`.
Причина — в ORM‑модели `Habit` отсутствовали связи `area` и `project`, несмотря на наличие столбцов в БД.
Сервис `list_habits` загружал связи через `selectinload`, что и вызывало падение.

**Воспроизведение:** открыть `/habits` при включённом фича‑флаге `HABITS_V1_ENABLED`.

**Исправление:** добавлены отношения в модели, DDL гарантирует FK на `areas`/`projects`,
`core.db.repair` наследует `area_id` от проекта и логирует случаи, когда оба идентификатора отсутствуют.
См. эпики [E16](./BACKLOG.md#e16-habits), [E12](./BACKLOG.md#e12-calendaralarms-fusion-сегодня--общий-список)
и [E13](./BACKLOG.md#e13-tasks--time-para-first).

### DB bootstrap / repair

```bash
python -m core.db.migrate && python -m core.db.repair
```

### Weekly digests

Включите недельные дайджесты привычек через переменные окружения
`HABITS_WEEKLY_DIGEST_ENABLED=true` и `ENABLE_SCHEDULER=1`. Расписание
задаётся строкой `DIGEST_WEEKLY_CRON`, например `"MON 08:00 Europe/Bucharest"`.
Для отправки сообщений необходимо настроить `project_notifications` с
привязанным Telegram‑чатом.

### Post-deploy checklist

- [ ] Запустить: `python -m core.db.migrate && python -m core.db.repair`.
- [ ] Зайти под web-пользователем без TG → `/habits` 200 OK, виден баннер и пустое состояние.
- [ ] Привязать TG → `/habits` показывает HUD и списки; клики по привычкам работают.
- [ ] Сделать два быстрых клика по привычке → второй запрос 429, UI показывает таймер.
- [ ] Проверить `/calendar/agenda?include_habits=1` → видны виртуальные ежедневки.
- [ ] Пройти `/api/v1/rewards/{id}/buy` с недостатком золота → 400.
- [ ] Просмотреть CHANGELOG [Unreleased] — новые пункты присутствуют.
