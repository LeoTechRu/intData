# Vision Deck

`vision.md` агрегирует проработанные идеи из `idea.md` и описывает целевые решения на уровне концепций. Именно здесь фиксируется «как должно работать» до детализации задач.

## Структура
- **Инициатива / кодовое имя** — отсылка к записи в `idea.md` или эпикам BACKLOG.
- **Цель** — какую пользовательскую или операционную проблему решаем.
- **Ключевые сценарии** — пользовательские флоу, которые должны поддерживаться.
- **Технический подход** — основные решения по архитектуре, данным, API, UI.
- **Ограничения и риски** — технические, продуктовые, организационные.
- **Критерии успеха** — метрики, инварианты, признаки завершённости.

## Активные инициативы

### Modular Navigation (E17)
- **Цель** — сократить когнитивную нагрузку от длинного списка страниц и ускорить доступ к связанным инструментам.
- **Ключевые сценарии**
  1. Пользователь группирует страницы в одноуровневые секции и скрывает второстепенные пункты, не теряя возможность восстановить их через редактор.
  2. Внутри выбранного модуля пользователь переключается между связанными страницами через верхние вкладки, не покидая контекста.
  3. На любой странице пользователь отмечает её звёздочкой, чтобы добавить в персональное избранное и мгновенно добраться до неё из левого меню.
- **Технический подход**
  - Расширить `NAV_BLUEPRINT` полями `module`, `section_order`, `category`, обновить `build_navigation_payload` и API `/api/v1/navigation/sidebar*`.
  - Перестроить `AppShell` и `SidebarEditor`: секции с заголовками, collapsible, drag-n-drop внутри секции; левое меню — единый список избранных страниц, которые можно скрывать или раскрывать без дублирования; состояние хранится в `user_settings.nav_sidebar`.
  - Добавить компонент `FavoriteToggle` в AppShell header, синхронизирующийся с `user_settings.nav_sidebar` без отдельного списка избранного.
  - Верхнее меню модулей — новый компонент `ModuleTabs`, получает конфигурацию из `NAV_BLUEPRINT` и данных страницы.
  - Тесты: модульные (navigation_service), UI-снепшоты SidebarEditor/AppShell, e2e-проверка добавления избранного.
- **Ограничения и риски**
  - Необходимо сохранить обратную совместимость для пользователей без новых настроек (fallback к плоскому списку).
  - Усложнение состояния навигации требует аккуратной синхронизации между глобальными и пользовательскими пресетами.
  - Требуется сохранить поведение «один пункт — одна страница»: звёздочка только управляет видимостью, без создания копий в меню.
- **Критерии успеха**
  - Пользователь может создать кастомную секцию, скрыть пункт и восстановить его из редактора без перезагрузки.
  - Звёздочка на странице включает/выключает видимость пункта в левом меню и отображается заполненной при активном состоянии.
  - Верхние вкладки модулей корректно отображаются на мобильных устройствах (<= 400 px) и десктопах (>= 1440 px).
  - Документация в `docs/conventions.md`, `docs/tasklist.md`, `docs/CHANGELOG.md` обновлена, тесты проходят.


### CRM Knowledge Hub (E18)
- **Цель** — построить собственную CRM, в которой сделки и участники жёстко связаны с PARA-контекстом и дополняются знаниями (заметки, решения, ретроспективы) по принципам Zettelkasten.
- **Ключевые сценарии**
  1. Руководитель продаж управляет цифровой воронкой, видит лиды по стадиям, конверсию, автоматизации и последовательности (ориентир — Bitrix24 sales tunnels, amoCRM Digital Pipeline).
  2. Куратор учебных групп открывает карточку участника, видит покупки, статус обучения и историю общения из единого контакт-центра (омниканальные паттерны Kommo).
  3. Команда принимает решения быстрее, потому что карточка сделки показывает связанные заметки, решения и бэклинки (Zettelkasten-слой знаний) вместе с рекомендациями AI.
- **Технический подход**
  - **Данные и сущности:** `crm_products`, `crm_product_versions` (потоки/релизы), `crm_product_tariffs`, `crm_deals`, `crm_accounts`, `crm_touchpoints`, `crm_subscriptions` — все наследуют PARA (`area_id`/`project_id`). Продукты выступают контейнером для тарифов и потоков; версии поддерживают иерархию и расписание.
  - **Клиенты на users_web:** добавление клиента создаёт `users_web` без пароля/username, но с обязательным email или телефоном. `users_telegram` присоединяется по контактам. При самостоятельной регистрации выполняется мёрдж по email/телефону.
  - **Авторизация:** единая форма для username/email/телефона. UI автоматически определяет тип ввода (`@`, `+7`, `digits`) и переключает проверку; бекенд унифицирует поиск пользователя и верификацию.
  - **Модуль `/crm`:** Next.js AppRouter, React Query. Подразделы: `/crm/deals` (канбан + последовательности), `/crm/accounts` (каталог контактов/компаний), `/crm/products` (карточка продукта с тарифами), `/crm/analytics` (канва pipeline health + knowledge coverage).
  - **Карточка сделки:** правая панель знаний (заметки, решения, ретроспективы, бэклинки), таймлайн коммуникаций, блок «Версия продукта / поток» с действиями «перевести в тариф/поток», «апгрейд/даунгрейд» (платный/бесплатный).
  - **Автоматизации:** DSL в `core/services/crm/automations.py` (триггеры: смена стадии, платеж, истечение потока, связанная заметка). Управление правилами — UI без кода с шаблонами (ориентир monday.com agents, Salesforce Agentforce). Фичефлаг `CRM_AUTOMATIONS_V1`.
  - **Контакт-центр:** единый таймлайн с сообщениями из Telegram-бота, email, звонков; AI-сводки, тональность (ориентир Kommo). Быстрые действия для ответа, постановки задачи или создания заметки.
  - **Переходы между потоками:** сервис `crm_subscription_service` обеспечивает upgrade/downgrade (платный/бесплатный), переназначает `crm_product_version_id`, логирует смену и инициирует автоматизации.
  - **Zettelkasten-слой:** заметки/решения (`notes`) получают `knowledge_node_id` с ссылкой на сделку/аккаунт; карточка знаний отображает обратные ссылки и предлагает создать новую заметку (fast capture в Inbox → assign в соответствующий проект/area).
  - **Наблюдаемость автоматизаций:** аудит-лог, Command Center с потоками событий (аналог Salesforce Agentforce Command Center) для диагностики.
- **UX-паттерны**
  - Канбан стадий + «туннели» (параллельные процессы) для сценариев «Продажа → Обучение → Продление».
  - Модуль продуктов объединяет карточки товара/курса, тарифы и расписание потоков; Historia версий отображает активные/завершённые потоки.
  - В карточке контакта контекст PARA, список активных сделок, подписок, заметок, автоматизаций и коммуникаций.
  - Визуализация «Knowledge coverage»: процент сделок с заметками, density граф бэклинков.
- **Ограничения и риски**
  - Необходимо обеспечить производительность при загрузке канбана + панели знаний; требуется lazy-loading и постраничность таймлайна.
  - Сложность автоматизаций и интеграций требует feature flag rollout и центра наблюдаемости.
  - Переходы между тарифами/потоками должны быть идемпотентны; нужен консистентный учёт оплат и прав доступа.
- **Критерии успеха**
  - Сделки, контакты, продукты, тарифы и потоки видны в обзорах PARA и синхронизируются без ручной связки.
  - Канбан CRM показывает конверсию и прогноз выручки; автоматизация допускает многошаговые сценарии (напоминания, переводы в потоки, уведомления бота).
  - Карточка сделки интегрирует таймлайн коммуникаций, панель знаний и действия по продукту/тарифу.
  - Пользователь может добавить клиента без пароля (email или телефон) и позже объединить с зарегистрированным аккаунтом.
  - Авторизация по username/email/телефону работает во фронтенде и API; UI корректно переключает режим.
  - Документация (conventions, changelog) зафиксировала правила данных, автоматизации и UX CRM.
